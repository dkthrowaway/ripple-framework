import {
  Canvas,
  Meta,
  Story,
  ArgsTable
} from '@storybook/addon-docs'
import { ref, provide } from 'vue'
import { RplAccordion } from '@dpc-sdp/ripple-ui-core/vue'
import RplMap from './RplMap.vue'
import RplMapProviderEsri from './providers/RplMapProviderEsri.vue'
import RplMapProviderVicMap from './providers/RplMapProviderVicMap.vue'
import RplMapProviderMapbox from './providers/RplMapProviderMapbox.vue'
import RplMapLegend from './../legend/RplMapLegend.vue'
import { transform } from 'ol/proj'
import Icon from 'ol/style/Icon'
import featureData from './__fixture__/features.json'
import '@dpc-sdp/ripple-ui-core/style/components'
import markerIconDefaultSrc from './../feature-pin/icon-pin.svg?url'
const getColor = (population) => {
  switch (true) {
    case population < 10491:
      return [255, 80, 156]
    case population < 30491:
      return [181, 0, 44]
    case population < 40491:
      return [242, 59, 72]
    case population < 80491:
      return [253, 218, 36]
  }
  return 'red'
}

export const Template = (args) => ({
  components: { RplMap, RplMapProviderEsri, RplMapProviderVicMap, RplMapProviderMapbox, RplAccordion, RplMapLegend },
  setup() {
    const rplMapRef = ref(null)
    function setRplMapRef(mapInstance) {
      rplMapRef.value = mapInstance
    }
    provide('rplMapInstance', {
      rplMapRef,
      setRplMapRef
    })
    const getClusteredFeatures = (itms) => {
      return itms.map(itm => {
        return {
          id: itm.id,
          title: itm.title,
          content: itm.description
        }
      })
    }
    return {
      getClusteredFeatures,
      args
    }
  },
  template: `
    <RplMap
      v-bind="args"
    >
      <template #map-provider>
        <rpl-map-provider-mapbox />
      </template>
      <template #popupTitle="{ selectedFeatures }">
        <span v-if="selectedFeatures.length === 1">
          {{ selectedFeatures[0].city}}
        </span>
        <span v-else>
          {{ selectedFeatures.length }} items found in this area
        </span>
      </template>
      <template #popupContent="{ selectedFeatures }">
        <p class="rpl-type-p-small" v-if="selectedFeatures.length === 1">
          {{ selectedFeatures[0].description}}
        </p>
        <RplAccordion v-else :items="getClusteredFeatures(selectedFeatures)">
        </RplAccordion>
      </template>
      <template #legend>
        <rpl-map-legend></rpl-map-legend>
      </template>
    </RplMap>
  `
})

<Meta
  title='Maps/core'
  component={RplMap}
/>

# Demo

<ArgsTable of={RplMap} />

<Canvas>
  <Story
    name='Custom pins'
    args={{
      id: 'dsafsdf',
      initialCenter: [
        16136905.843820328,
        -4383057.013522999
      ],
      features: featureData.map(itm => {
        const geoPoint = transform([itm.lng, itm.lat], 'EPSG:4326', 'EPSG:3857')
        return {
          ...itm,
          lng: geoPoint[0],
          lat: geoPoint[1]
        }
      }),
      pinStyle: (feature) => {
        const population = feature.get('population')
        const ic = new Icon({
          src: markerIconDefaultSrc,
          color: getColor(population)
        })
        ic.load()
        return ic
      },
      projection: 'EPSG:3857'
    }}
  >
    {Template.bind()}
  </Story>
</Canvas>
